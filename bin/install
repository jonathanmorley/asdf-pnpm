#!/usr/bin/env bash
# shellcheck shell=bash

set -Eeuo pipefail

if [[ ${ASDF_INSTALL_TYPE:-version} == 'ref' ]]; then
  echo >&2 "â›” This plugin does not support installing by ref."
  exit 1
fi

if [[ -n ${ASDF_DOWNLOAD_PATH:-} ]]; then
  echo "Using ASDF_DOWNLOAD_PATH: ${ASDF_DOWNLOAD_PATH}"
  cp -r "${ASDF_DOWNLOAD_PATH}"/* "${ASDF_INSTALL_PATH}"/
else
  # Legacy path: download directly to install path
  export ASDF_DOWNLOAD_PATH="${ASDF_INSTALL_PATH}"
  bash "$(dirname "$0")/download"
fi

# v1 doesn't have a bin/dir (its binaries are in lib/bin)
mkdir -p "${ASDF_INSTALL_PATH}/bin"

BINARIES=('pnpm' 'pnpx')
for bin in "${BINARIES[@]}"; do
  BIN_PATH=""
  BINARY_PATHS=(
    "${ASDF_INSTALL_PATH}/bin/${bin}.cjs"    #v6
    "${ASDF_INSTALL_PATH}/bin/${bin}.js"     #v2 - v5
    "${ASDF_INSTALL_PATH}/lib/bin/${bin}.js" #v1
  )

  for BINARY_PATH in "${BINARY_PATHS[@]}"; do
    if [[ -f ${BINARY_PATH} ]]; then
      BIN_PATH="${BINARY_PATH}"
      break
    fi
  done

  if [[ -z $BIN_PATH ]]; then
    echo >&2 "Could not find ${bin} binary in any expected location"
    exit 1
  fi

  # v1 to v2 binaries are not executable
  chmod +x "${BIN_PATH}"

  ln -sf "${BIN_PATH}" "${ASDF_INSTALL_PATH}/bin/${bin}"
done
