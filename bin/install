#!/usr/bin/env bash

set -Eeuo pipefail

if [[ "${ASDF_INSTALL_TYPE:-version}" == 'ref' ]]; then
  echo >&2 "â›” This plugin does not support installing by ref."
  exit 1
fi

FALLBACK_REGISTRY='https://registry.npmjs.org/'

REGISTRY="${NPM_CONFIG_REGISTRY:-$FALLBACK_REGISTRY/}"
if command -v npm 1>/dev/null; then
  REGISTRY=$(npm config get registry)
fi

mkdir -p "${ASDF_INSTALL_PATH}"

get_auth_header() {
  local reg="$1"
  local auth_header=""

  # Extract hostname from registry URL for auth token lookup
  local hostname
  hostname=$(echo "$reg" | sed -E 's|^https?://([^/]+).*|\1|')

  # Function to read from .npmrc files
  read_npmrc_auth() {
    local host="$1"
    local auth_token=""
    local auth_basic=""

    # Check project .npmrc first (current directory)
    if [[ -f ".npmrc" ]]; then
      auth_token=$(grep "^//${host}/:_authToken" ".npmrc" 2>/dev/null | cut -d'=' -f2)
      if [[ -z "$auth_token" ]]; then
        auth_basic=$(grep "^//${host}/:_auth" ".npmrc" 2>/dev/null | cut -d'=' -f2)
      fi
    fi

    # Check user .npmrc if project .npmrc didn't have it
    if [[ -z "$auth_token" && -z "$auth_basic" && -f "$HOME/.npmrc" ]]; then
      auth_token=$(grep "^//${host}/:_authToken" "$HOME/.npmrc" 2>/dev/null | cut -d'=' -f2)
      if [[ -z "$auth_token" ]]; then
        auth_basic=$(grep "^//${host}/:_auth" "$HOME/.npmrc" 2>/dev/null | cut -d'=' -f2)
      fi
    fi

    if [[ -n "$auth_token" ]]; then
      echo "Bearer $auth_token"
    elif [[ -n "$auth_basic" ]]; then
      echo "Basic $auth_basic"
    fi
  }

  # Try to read auth from .npmrc files
  local npmrc_auth
  npmrc_auth=$(read_npmrc_auth "$hostname")
  if [[ -n "$npmrc_auth" ]]; then
    auth_header="Authorization: $npmrc_auth"
  fi

  # Fallback to environment variables
  if [[ -z "$auth_header" ]]; then
    if [[ -n "${NPM_TOKEN:-}" ]]; then
      auth_header="Authorization: Bearer $NPM_TOKEN"
    elif [[ -n "${NPM_AUTH_TOKEN:-}" ]]; then
      auth_header="Authorization: Bearer $NPM_AUTH_TOKEN"
    fi
  fi

  echo "$auth_header"
}

download_and_extract() {
  local reg="$1"
  local tarball_url="${reg%/}/pnpm/-/pnpm-${ASDF_INSTALL_VERSION}.tgz"
  local auth_header
  auth_header=$(get_auth_header "$reg")

  echo "Downloading pnpm v${ASDF_INSTALL_VERSION} from ${tarball_url}"

  if [[ -n "$auth_header" ]]; then
    curl --silent --fail --location --header "$auth_header" "${tarball_url}" |
      tar xzf - --strip-components=1 --no-same-owner -C "${ASDF_INSTALL_PATH}"
  else
    curl --silent --fail --location "${tarball_url}" |
      tar xzf - --strip-components=1 --no-same-owner -C "${ASDF_INSTALL_PATH}"
  fi
}

# Try with configured registry first, fall back to default if it's different and the first attempt fails
if ! download_and_extract "$REGISTRY" 2>/dev/null; then
  # Remove trailing slashes for comparison
  if [ "${REGISTRY%/}" != "${FALLBACK_REGISTRY%/}" ]; then
    echo "Download from configured registry failed, trying fallback registry..."
    download_and_extract "$FALLBACK_REGISTRY"
  else
    echo "Download from registry failed."
    exit 1
  fi
fi

# v1 doesn't have a bin/dir (its binaries are in lib/bin)
mkdir -p "${ASDF_INSTALL_PATH}/bin"

BINARIES=('pnpm' 'pnpx')
for bin in "${BINARIES[@]}"; do
  BINARY_PATHS=(
    "${ASDF_INSTALL_PATH}/bin/${bin}.cjs"    #v6
    "${ASDF_INSTALL_PATH}/bin/${bin}.js"     #v2 - v5
    "${ASDF_INSTALL_PATH}/lib/bin/${bin}.js" #v1
  )

  for BINARY_PATH in "${BINARY_PATHS[@]}"; do
    if [[ -f "${BINARY_PATH}" ]]; then
      BIN_PATH="${BINARY_PATH}"
      break
    fi
  done

  # v1 to v2 binaries are not executable
  chmod +x "${BIN_PATH}"

  ln -sf "${BIN_PATH}" "${ASDF_INSTALL_PATH}/bin/${bin}"
done
