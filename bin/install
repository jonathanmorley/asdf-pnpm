#!/usr/bin/env bash

set -Eeuo pipefail

if [[ "${ASDF_INSTALL_TYPE:-version}" == 'ref' ]]; then
  echo >&2 "â›” This plugin does not support installing by ref."
  exit 1
fi

TARBALL_URL="https://registry.npmjs.org/pnpm/-/pnpm-${ASDF_INSTALL_VERSION}.tgz"

mkdir -p "${ASDF_INSTALL_PATH}"

echo "Downloading pnpm v${ASDF_INSTALL_VERSION}"

curl --silent --fail --show-error --location "${TARBALL_URL}" |
  tar xzf - --strip-components=1 --no-same-owner -C "${ASDF_INSTALL_PATH}"

# executables
for bin in pnpm pnpx; do
  # v6 executables are .cjs in bin/
  if [[ -f "${ASDF_INSTALL_PATH}/bin/${bin}.cjs" ]]; then
    ln -sf "${bin}.cjs" "${ASDF_INSTALL_PATH}/bin/${bin}"
  # v2 executables are .js in bin/
  elif [[ -f "${ASDF_INSTALL_PATH}/bin/${bin}.js" ]]; then
    # v2 executables are not executable
    chmod +x "${ASDF_INSTALL_PATH}/bin/${bin}.js"
    ln -sf "${bin}.js" "${ASDF_INSTALL_PATH}/bin/${bin}"
  # v1 executables are in lib/bin/
  elif [[ -f "${ASDF_INSTALL_PATH}/lib/bin/${bin}.js" ]]; then
    chmod +x "${ASDF_INSTALL_PATH}/lib/bin/${bin}.js"
    mkdir -p "${ASDF_INSTALL_PATH}/bin"
    ln -sf "../lib/bin/${bin}.js" "${ASDF_INSTALL_PATH}/bin/${bin}"
  fi
done
